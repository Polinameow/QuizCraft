<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö–≤–∏–∑–ö—Ä–∞—Ñ—Ç</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="./arialuni-normal.js"></script>
</head>
<body>
<div class="theme-switcher">
    <div class="theme-btn" id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
        <span id="themeIcon">üåô</span>
    </div>
</div>

<div class="container">
    <!-- –ë–ª–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –æ–ø—Ä–æ—Å–∞ -->
    <div id="createPollForm" class="form">
        <h2>–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å</h2>
        <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ–ø—Ä–æ—Å–∞" id="pollTitleInput" class="form-control"/>
        
        <div class="mb-3">
            <label for="pollTimerInput" class="form-label">–¢–∞–π–º–µ—Ä –æ–ø—Ä–æ—Å–∞ (–º–∏–Ω—É—Ç—ã):</label>
            <input type="number" id="pollTimerInput" min="1" class="form-control" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ —Ç–∞–π–º–µ—Ä –Ω–µ –Ω—É–∂–µ–Ω">
        </div>
        
        <h3>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å</h3>
        <div id="questionsContainer">
            <div class="questionItem card p-3 mb-3">
                <label for="question">–í–æ–ø—Ä–æ—Å:</label><br/>
                <input type="text" class="questionInput form-control"/>
                
                <label class="mt-2">–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞:</label>
                <select class="questionType form-select">
                    <option value="single">–û–¥–∏–Ω–æ—á–Ω—ã–π –≤—ã–±–æ—Ä</option>
                    <option value="multiple">–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä</option>
                    <option value="text">–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç</option>
                    <option value="scale">–®–∫–∞–ª–∞ (1-10)</option>
                </select>
                
                <div class="answerOptionsContainer mt-2">
                    <button onclick="addAnswerOption(this)" class="btn btn-primary mt-2">–î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞</button>
                    <ul class="answerOptionsList list-group mt-2"></ul>
                </div>
            
                <button onclick="removeQuestion(this)" class="btn btn-danger mt-2">–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
            </div>
        </div>
        <button onclick="addNewQuestion()" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å</button>
        <button onclick="savePoll()" class="btn btn-info">–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å</button>
    </div>

    <!-- –ë–ª–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ–ø—Ä–æ—Å–∞ -->
    <div id="resultBlock" style="display:none;">
        <div class="chart-container">
            <canvas id="resultsChart"></canvas>
        </div>
        <p id="resultText" class="text-center"></p>
        
        <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –æ—Ç–≤–µ—Ç–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div id="userAnswersTable" style="display: none;">
            <h4 class="text-center mt-4">–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã</h4>
            <table class="answers-table">
                <thead>
                    <tr>
                        <th>–í–æ–ø—Ä–æ—Å</th>
                        <th>–í–∞—à –æ—Ç–≤–µ—Ç</th>
                        <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                    </tr>
                </thead>
                <tbody id="answersTableBody">
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-center gap-2 mt-4">
            <a href="#" id="copyLinkButton" onclick="copyToClipboard()" class="btn btn-primary">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø—Ä–æ—Å</a>
            <button id="exportPdfButton" onclick="exportToPDF()" class="btn btn-secondary">–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
            <button id="showQRCodeButton" onclick="showQRCode()" class="btn btn-secondary">–ü–æ–∫–∞–∑–∞—Ç—å QR-–∫–æ–¥</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–∫–∞–∑–∞ QR-–∫–æ–¥–∞ -->
    <div id="qrModal">
        <div id="qrModalContent" class="card">
            <span id="closeQrModal" onclick="hideQRCode()">√ó</span>
            <h4>–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø—Ä–æ—Å</h4>
            <img id="qrImage" alt="QR Code">
            <p id="qrLinkText" style="word-break: break-all; font-size: 12px;"></p>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è -->
    <div id="voteForm" style="display:none;" class="form">
        <div id="timerContainer" class="timer-container" style="display: none;">
            <span id="timerText">–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏: </span>
            <span id="timerValue"></span>
        </div>
        <h2 id="pollTitle"></h2>
        <form id="voteFormInner">
            <ol id="voteQuestionsList"></ol>
            <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
    </div>
</div>
<script>
let pollData = {};
let currentPollUrl = '';
let resultsChart = null;
let timerInterval = null;
let timeLeft = 0;
let userResults = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

// –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –æ–ø—Ä–æ—Å–∞
const generateUUID = () => ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>c^Math.random()*16>>c/4|0).toString(16);

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è URL –æ–ø—Ä–æ—Å–∞
const getPollUrl = (pollId) => {
    let baseUrl = window.location.href;
    baseUrl = baseUrl.split('#')[0].split('?')[0];
    baseUrl = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;
    return `${baseUrl}#${pollId}`;
};

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ URL
const isValidUrl = (url) => {
    try {
        new URL(url);
        return true;
    } catch (e) {
        return false;
    }
};

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
};

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
const updateTimer = () => {
    const timerValue = document.getElementById('timerValue');
    const timerContainer = document.getElementById('timerContainer');
    
    if (timeLeft <= 0) {
        clearInterval(timerInterval);
        timerInterval = null;
        timerValue.textContent = "–í—Ä–µ–º—è –≤—ã—à–ª–æ!";
        timerContainer.className = "timer-container timer-ended";
        if (document.getElementById('voteFormInner')) {
            document.getElementById('voteFormInner').dispatchEvent(new Event('submit'));
        }
        return;
    }
    
    timerValue.textContent = formatTime(timeLeft);
    
    if (timeLeft <= 30) {
        timerContainer.className = "timer-container timer-warning";
    } else {
        timerContainer.className = "timer-container";
    }
    
    timeLeft--;
};

// –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
const startTimer = (durationInMinutes) => {
    if (timerInterval) {
        clearInterval(timerInterval);
    }
    
    timeLeft = durationInMinutes * 60;
    document.getElementById('timerContainer').style.display = 'block';
    updateTimer();
    timerInterval = setInterval(updateTimer, 1000);
};

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
const addNewQuestion = () => {
    const questionsContainer = document.getElementById('questionsContainer');
    const newQuestionDiv = `
        <div class="questionItem card p-3 mb-3">
            <label for="question">–í–æ–ø—Ä–æ—Å:</label><br/>
            <input type="text" class="questionInput form-control"/>
            
            <label class="mt-2">–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞:</label>
            <select class="questionType form-select">
                <option value="single">–û–¥–∏–Ω–æ—á–Ω—ã–π –≤—ã–±–æ—Ä</option>
                <option value="multiple">–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä</option>
                <option value="text">–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç</option>
                <option value="scale">–®–∫–∞–ª–∞ (1-10)</option>
            </select>
            
            <div class="answerOptionsContainer mt-2">
                <button onclick="addAnswerOption(this)" class="btn btn-primary mt-2">–î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞</button>
                <ul class="answerOptionsList list-group mt-2"></ul>
            </div>
        
            <button onclick="removeQuestion(this)" class="btn btn-danger mt-2">–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
        </div>
    `;
    questionsContainer.insertAdjacentHTML('beforeend', newQuestionDiv);
    
    const newQuestion = questionsContainer.lastElementChild;
    newQuestion.querySelector('.questionType').addEventListener('change', function() {
        updateQuestionType(this);
    });
};

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞
const updateQuestionType = (selectElement) => {
    const questionItem = selectElement.closest('.questionItem');
    const answerOptionsContainer = questionItem.querySelector('.answerOptionsContainer');
    const answerOptionsList = questionItem.querySelector('.answerOptionsList');
    
    const questionType = selectElement.value;
    answerOptionsList.innerHTML = '';
    
    if (questionType === 'text') {
        answerOptionsContainer.style.display = 'none';
    } else if (questionType === 'scale') {
        answerOptionsContainer.style.display = 'block';
        const scaleContainer = document.createElement('div');
        scaleContainer.className = 'scale-options';
        
        for (let i = 1; i <= 10; i++) {
            const scaleOption = document.createElement('div');
            scaleOption.className = 'scale-option';
            
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = `scale_${questionItem.querySelector('.questionInput').value.replace(/\W/g, '')}`;
            radio.value = i;
            
            const label = document.createElement('label');
            label.textContent = i;
            
            scaleOption.appendChild(radio);
            scaleOption.appendChild(label);
            scaleContainer.appendChild(scaleOption);
        }
        
        answerOptionsList.appendChild(scaleContainer);
    } else {
        answerOptionsContainer.style.display = 'block';
    }
};

// –£–¥–∞–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞
const removeQuestion = (btn) => {
    btn.closest('.questionItem').remove();
};

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞
const addAnswerOption = (contextBtn) => {
    const parentEl = contextBtn.closest('.questionItem');
    const questionType = parentEl.querySelector('.questionType').value;
    
    if (questionType === 'scale') return;
    
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    
    const answerInput = document.createElement('input');
    answerInput.type = 'text';
    answerInput.placeholder = '–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞';
    answerInput.className = 'form-control me-2';
    answerInput.style.color = '#000000'; /* –ß–µ—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ */

    const correctCheckbox = document.createElement('input');
    correctCheckbox.type = 'checkbox';
    correctCheckbox.name = 'correct';
    correctCheckbox.className = 'me-2';

    const removeBtn = document.createElement('button');
    removeBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
    removeBtn.className = 'btn btn-warning btn-sm';
    removeBtn.onclick = function () { this.parentNode.remove(); };

    li.appendChild(answerInput);
    li.appendChild(correctCheckbox);
    li.appendChild(removeBtn);

    parentEl.querySelector('.answerOptionsList').appendChild(li);
};

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ–ø—Ä–æ—Å–∞
const savePoll = () => {
    let title = document.getElementById('pollTitleInput').value.trim();
    if (!title) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ –ù–∞–∑–≤–∞–Ω–∏–µ –æ–ø—Ä–æ—Å–∞!");

    const timerInput = document.getElementById('pollTimerInput');
    const timerMinutes = timerInput.value ? parseInt(timerInput.value) : 0;

    let questions = [];
    Array.from(document.querySelectorAll('.questionItem')).forEach(qItem => {
        let qText = qItem.querySelector('.questionInput').value.trim();
        if (!qText) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ –í–æ–ø—Ä–æ—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—É–Ω–∫—Ç–∞.");

        const questionType = qItem.querySelector('.questionType').value;
        let answers = [];
        
        if (questionType === 'text') {
            answers.push({ value: '–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç', correct: false });
        } else if (questionType === 'scale') {
            for (let i = 1; i <= 10; i++) {
                answers.push({ value: i.toString(), correct: false });
            }
        } else {
            Array.from(qItem.querySelectorAll('.answerOptionsList > li')).forEach(optEl => {
                let optVal = optEl.querySelector('input[type=text]')?.value.trim() || '';
                if (optVal.length === 0) return;
                let isCorrect = optEl.querySelector('input[name=correct]:checked') !== null;
                answers.push({ value: optVal, correct: isCorrect });
            });

            if (answers.length === 0 && questionType !== 'text') {
                return alert("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –º–∏–Ω–∏–º—É–º –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.");
            }
        }

        questions.push({
            question: qText,
            type: questionType,
            answers: answers
        });
    });

    if (questions.length === 0) return alert("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –º–∏–Ω–∏–º—É–º –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å.");

    let uniqueID = generateUUID();
    pollData = {
        uuid: uniqueID,
        title: title,
        timerMinutes: timerMinutes,
        questions: questions
    };

    localStorage.setItem(uniqueID, JSON.stringify(pollData));
    currentPollUrl = getPollUrl(uniqueID);
    
    if (!isValidUrl(currentPollUrl)) {
        console.error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL –æ–ø—Ä–æ—Å–∞:', currentPollUrl);
        return;
    }
    
    window.location.hash = '#' + uniqueID;
    showVoteForm(pollData);
};

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –æ–ø—Ä–æ—Å–∞ –ø–æ —Å—Å—ã–ª–∫–µ
const loadPollFromURL = () => {
    const hash = window.location.hash.slice(1);
    if (hash) {
        const storedPoll = localStorage.getItem(hash);
        if (storedPoll) {
            pollData = JSON.parse(storedPoll);
            currentPollUrl = getPollUrl(hash);
            if (document.getElementById('resultBlock').style.display !== 'block') {
                showVoteForm(pollData);
            }
        } else {
            document.getElementById('createPollForm').style.display = 'block';
            document.getElementById('voteForm').style.display = 'none';
            document.getElementById('resultBlock').style.display = 'none';
        }
    }
};

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
const showVoteForm = (data) => {
    document.getElementById('createPollForm').style.display = 'none';
    document.getElementById('voteForm').style.display = 'block';
    document.getElementById('resultBlock').style.display = 'none';

    document.getElementById('pollTitle').innerHTML = data.title;

    if (data.timerMinutes && data.timerMinutes > 0) {
        startTimer(data.timerMinutes);
    }

    const voteQuestionsList = document.getElementById('voteQuestionsList');
    voteQuestionsList.innerHTML = '';

    data.questions.forEach((questionObj, qIndex) => {
        const olItem = document.createElement('li');
        olItem.className = 'mb-4';
        olItem.innerHTML = `<strong>${questionObj.question}</strong>`;

        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-container mt-2';
        
        if (questionObj.type === 'text') {
            const textarea = document.createElement('textarea');
            textarea.name = `q${qIndex}`;
            textarea.placeholder = '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç...';
            textarea.className = 'form-control';
            questionDiv.appendChild(textarea);
        } else if (questionObj.type === 'scale') {
            const scaleContainer = document.createElement('div');
            scaleContainer.className = 'scale-options';
            
            for (let i = 1; i <= 10; i++) {
                const scaleOption = document.createElement('div');
                scaleOption.className = 'scale-option';
                
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = `q${qIndex}`;
                radio.value = i;
                radio.id = `q${qIndex}_opt${i}`;
                radio.className = 'form-check-input';
                
                const label = document.createElement('label');
                label.textContent = i;
                label.htmlFor = `q${qIndex}_opt${i}`;
                label.className = 'form-check-label';
                
                scaleOption.appendChild(radio);
                scaleOption.appendChild(label);
                scaleContainer.appendChild(scaleOption);
            }
            
            questionDiv.appendChild(scaleContainer);
        } else {
            const ulAnswers = document.createElement('ul');
            ulAnswers.className = 'answer-options list-group';
            
            questionObj.answers.forEach((ans, aIndex) => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                
                const div = document.createElement('div');
                div.className = 'form-check';
                
                const input = document.createElement('input');
                input.type = questionObj.type === 'single' ? 'radio' : 'checkbox';
                input.name = `q${qIndex}`;
                input.value = ans.value;
                input.id = `q${qIndex}_opt${aIndex}`;
                input.className = 'form-check-input';
                
                const label = document.createElement('label');
                label.textContent = ans.value;
                label.htmlFor = `q${qIndex}_opt${aIndex}`;
                label.className = 'form-check-label';
                
                div.appendChild(input);
                div.appendChild(label);
                li.appendChild(div);
                ulAnswers.appendChild(li);
            });
            
            questionDiv.appendChild(ulAnswers);
        }
        
        olItem.appendChild(questionDiv);
        voteQuestionsList.appendChild(olItem);
    });

    document.getElementById('voteFormInner').onsubmit = handleSubmit;
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤
const handleSubmit = e => {
    e.preventDefault();

    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }

    let totalCorrect = 0;
    let totalIncorrect = 0;
    let totalQuestions = 0;
    userResults = [];
    
    pollData.questions.forEach((q, qIndex) => {
        if (q.type === 'text') {
            const textAnswer = document.querySelector(`textarea[name=q${qIndex}]`).value.trim();
            if (!textAnswer) return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã!");
            
            totalIncorrect++;
            totalQuestions++;
            
            userResults.push({
                question: q.question,
                answer: textAnswer,
                type: q.type,
                correct: false
            });
        } else {
            const inputs = [...document.querySelectorAll(`input[name=q${qIndex}]:checked`)];
            if (inputs.length === 0 && q.type !== 'scale') {
                return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã!");
            }
            
            const userSelections = inputs.map(input => input.value);
            let correctAnswers = q.answers.filter(a => a.correct).map(a => a.value);
            let isCorrect = false;
            
            if (q.type === 'single' || q.type === 'multiple') {
                const userCorrect = userSelections.filter(val => 
                    q.answers.find(a => a.value === val && a.correct)
                ).length;
                
                const requiredCorrect = correctAnswers.length;
                
                if (q.type === 'single') {
                    isCorrect = userCorrect === 1 && requiredCorrect === 1 && 
                               userSelections[0] === correctAnswers[0];
                } else {
                    isCorrect = userCorrect === requiredCorrect && 
                               userSelections.length === correctAnswers.length;
                }
            } else if (q.type === 'scale') {
                isCorrect = true;
            }
            
            if (isCorrect) {
                totalCorrect++;
            } else {
                totalIncorrect++;
            }
            totalQuestions++;
            
            userResults.push({
                question: q.question,
                selections: userSelections,
                type: q.type,
                correct: isCorrect
            });
        }
    });

    showResults(totalCorrect, totalIncorrect, totalQuestions);
};

// –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º–æ–π
const showResults = (correct, incorrect, total) => {
    document.getElementById('voteForm').style.display = 'none';
    document.getElementById('resultBlock').style.display = 'block';
    
    const percentage = Math.round((correct / total) * 100);
    document.getElementById('resultText').innerHTML = `
        <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ä–æ—Å–∞</h4>
        <p>–í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞ ${correct} –∏–∑ ${total} –≤–æ–ø—Ä–æ—Å–æ–≤</p>
        <p>–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${percentage}%</p>
    `;
    
    const ctx = document.getElementById('resultsChart').getContext('2d');
    
    if (resultsChart) {
        resultsChart.destroy();
    }
    
    resultsChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã', '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã'],
            datasets: [{
                data: [correct, incorrect],
                backgroundColor: ['#4CAF50', '#F44336'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    showUserAnswersTable();
};

// –ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å –æ—Ç–≤–µ—Ç–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const showUserAnswersTable = () => {
    const tableBody = document.getElementById('answersTableBody');
    tableBody.innerHTML = '';
    
    userResults.forEach((result, index) => {
        const row = document.createElement('tr');
        
        // –í–æ–ø—Ä–æ—Å
        const questionCell = document.createElement('td');
        questionCell.textContent = result.question;
        row.appendChild(questionCell);
        
        // –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const answerCell = document.createElement('td');
        if (result.type === 'text') {
            answerCell.textContent = result.answer;
        } else {
            answerCell.textContent = result.selections.join(', ');
        }
        row.appendChild(answerCell);
        
        // –†–µ–∑—É–ª—å—Ç–∞—Ç
        const resultCell = document.createElement('td');
        if (result.correct) {
            resultCell.textContent = '‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ';
            resultCell.className = 'correct-answer';
        } else {
            resultCell.textContent = '‚úó –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ';
            resultCell.className = 'incorrect-answer';
        }
        row.appendChild(resultCell);
        
        tableBody.appendChild(row);
    });
    
    document.getElementById('userAnswersTable').style.display = 'block';
};

// –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø—Ä–æ—Å
const copyToClipboard = () => {
    if (!currentPollUrl) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –æ–ø—Ä–æ—Å!');
        return;
    }
    navigator.clipboard.writeText(currentPollUrl).then(() => {
        alert('–°—Å—ã–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞: ' + currentPollUrl);
    }).catch(err => console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err));
};

// –≠–∫—Å–ø–æ—Ä—Ç –æ–ø—Ä–æ—Å–∞ –≤ PDF
const exportToPDF = () => {
    try {
        window.jsPDF = window.jspdf.jsPDF;
        const doc = new jsPDF();
        doc.setFont('arialuni');
        doc.setFontSize(16);

        doc.text(pollData.title, 10, 10);

        let yPosition = 20;
        
        if (pollData.timerMinutes && pollData.timerMinutes > 0) {
            doc.setFontSize(12);
            doc.text(`–¢–∞–π–º–µ—Ä –æ–ø—Ä–æ—Å–∞: ${pollData.timerMinutes} –º–∏–Ω—É—Ç`, 10, yPosition);
            yPosition += 10;
        }
        
        pollData.questions.forEach((question, index) => {
            doc.setFontSize(14);
            doc.text(`–í–æ–ø—Ä–æ—Å ‚Ññ${index+1}: ${question.question} (${getQuestionTypeName(question.type)})`, 10, yPosition);
            yPosition += 10;

            if (question.type !== 'text') {
                question.answers.forEach((answer, answerIndex) => {
                    doc.setFontSize(12);
                    doc.text(`   –í–∞—Ä–∏–∞–Ω—Ç ${answerIndex+1}: ${answer.value}`, 10, yPosition);
                    yPosition += 10;
                });
            } else {
                doc.setFontSize(12);
                doc.text(`   –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç`, 10, yPosition);
                yPosition += 10;
            }

            yPosition += 10;
        });

        doc.save(`${pollData.title}_–æ–ø—Ä–æ—Å.pdf`);
    } catch (err) {
        alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF: ' + err.message);
    }
};

// –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞
const getQuestionTypeName = (type) => {
    switch(type) {
        case 'single': return '–û–¥–∏–Ω–æ—á–Ω—ã–π –≤—ã–±–æ—Ä';
        case 'multiple': return '–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä';
        case 'text': return '–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç';
        case 'scale': return '–®–∫–∞–ª–∞ (1-10)';
        default: return type;
    }
};

// –ü–æ–∫–∞–∑ QR-–∫–æ–¥–∞
const showQRCode = () => {
    if (!currentPollUrl) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –æ–ø—Ä–æ—Å!');
        return;
    }
    
    if (!isValidUrl(currentPollUrl)) {
        alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø—Ä–æ—Å!');
        return;
    }
    
    try {
        const typeNumber = 0;
        const errorCorrectionLevel = 'L';
        const qr = qrcode(typeNumber, errorCorrectionLevel);
        
        qr.addData(currentPollUrl);
        qr.make();
        
        const qrImageUrl = qr.createDataURL(4, 0);
        
        document.getElementById('qrImage').src = qrImageUrl;
        document.getElementById('qrLinkText').textContent = currentPollUrl;
        document.getElementById('qrModal').style.display = 'block';
        
        console.log('QR-–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –¥–ª—è URL:', currentPollUrl);
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ QR-–∫–æ–¥–∞:', e);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ QR-–∫–æ–¥–∞: ' + e.message);
    }
};

// –°–∫—Ä—ã—Ç—å QR-–∫–æ–¥
const hideQRCode = () => {
    document.getElementById('qrModal').style.display = 'none';
};

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
const toggleTheme = () => {
    const body = document.body;
    const themeIcon = document.getElementById('themeIcon');
    
    if (body.classList.contains('dark-theme')) {
        body.classList.remove('dark-theme');
        themeIcon.textContent = 'üåô';
        localStorage.setItem('theme', 'light');
    } else {
        body.classList.add('dark-theme');
        themeIcon.textContent = '‚òÄÔ∏è';
        localStorage.setItem('theme', 'dark');
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
const initTheme = () => {
    const savedTheme = localStorage.getItem('theme') || 'light';
    const body = document.body;
    const themeIcon = document.getElementById('themeIcon');
    
    if (savedTheme === 'dark') {
        body.classList.add('dark-theme');
        themeIcon.textContent = '‚òÄÔ∏è';
    } else {
        body.classList.remove('dark-theme');
        themeIcon.textContent = 'üåô';
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    initTheme();
    loadPollFromURL();
    
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    window.addEventListener('hashchange', loadPollFromURL);
    
    document.querySelectorAll('.questionType').forEach(select => {
        select.addEventListener('change', function() {
            updateQuestionType(this);
        });
    });
});
</script>
</body>
</html>